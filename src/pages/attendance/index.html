<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務実績入力</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        button { background-color: #06C755; color: white; border: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <h3>勤務入力フォーム</h3>
    <form id="workForm">
        <label for="datePicker">日付を選択:</label>
        <input type="date" id="datePicker">
        <div id="result">
            勤務場所: <span id="locationDisplay">読み込み中...</span>
        </div>
        <label>開始時間</label>
        <input type="time" id="startTime" required>
        <label>終了時間</label>
        <input type="time" id="endTime" required>
        <label>備考</label>
        <input type="text" id="memo">
        <button type="submit">送信する</button>
    </form>

    <script>
	  const LIFF_ID = '2008956543-HV2ZIzKe'; 
	  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKD_Su-tKQNM9U07-2S3I1yvBn-9bAKFABzwSTeckViKFomaP_Zm0K0L_EsYf_bSDSvg/exec';

	  async function main() {
	    try {
	      await liff.init({ liffId: LIFF_ID });
	      if (!liff.isLoggedIn()) {
	        liff.login();
	        return;
	      }

	      // 1. 日付選択inputを取得
	      const datePicker = document.getElementById('datePicker');
	      
	      // 2. 今日の日付をデフォルトセット (YYYY-MM-DD)
	      const today = new Date().toLocaleDateString('sv-SE'); 
	      datePicker.value = today;

	      // 3. 初回読み込み（今日の日付で検索）
	      fetchShift(today);

	      // 4. 日付が変わったら再検索
	      datePicker.addEventListener('change', (e) => {
	        fetchShift(e.target.value);
	      });

	    } catch (error) {
	      console.error('LIFF初期化失敗', error);
	    }
	  }

	  // GASにデータを問い合わせる関数
	  async function fetchShift(selectedDate) {
	    const display = document.getElementById('locationDisplay');
	    display.innerText = "読み込み中...";

	    try {
	      const profile = await liff.getProfile();
	      const userId = profile.userId;

	      const response = await fetch(GAS_URL, {
	        method: "POST",
	        body: JSON.stringify({
	          action: "shift_search",
	          userId: userId,
	          targetDate: selectedDate
	        })
	      });

	      const data = await response.json();
	      display.innerText = data.location; // GASから返ってきた値を表示

	    } catch (error) {
	      console.error(error);
	      display.innerText = "エラー：取得できませんでした";
	    }
	  }
	  main();
	  
	  document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ユーザー情報の取得
            const profile = await liff.getProfile();
            
            const formData = {
            	action: "achieve",
                userId: profile.userId,
                userName: profile.displayName,
                date: document.getElementById('datePicker').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                memo: document.getElementById('memo').value
            };

            // GASへデータを送信
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            alert('送信完了！お疲れ様でした。');
            liff.closeWindow(); // LIFFを閉じる
        });
	</script>
</body>
</html>